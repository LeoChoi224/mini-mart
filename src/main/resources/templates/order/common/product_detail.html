<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout.html :: common-head('ìƒí’ˆ ìƒì„¸ ì •ë³´')"></head>
<body>
    <div th:replace="~{fragments/layout.html :: fragment-body-menu}"></div>

    <div class="main-container">
        <div class="product-detail-container">
            <!-- ìƒí’ˆ ì´ë¯¸ì§€ ì˜ì—­ -->
            <div class="product-image-section">
                <div class="main-image">
                    <img th:src="@{'/images/' + (${product.mainImageUrl} ?: ${product.imageUrl})}" 
                         alt="ìƒí’ˆ ì´ë¯¸ì§€" class="product-detail-image">
                </div>
                <div class="product-badges" style="margin-top: 1rem;">
                    <span class="badge badge-new" th:if="${product.isNew}">ğŸ†• ì‹ ìƒí’ˆ</span>
                    <span class="badge badge-sale" th:if="${product.discountRate > 0}">ğŸ’° í• ì¸</span>
                    <span class="badge badge-best" th:if="${product.isBest}">â­ ë² ìŠ¤íŠ¸</span>
                    <span class="badge" th:if="${product.isFeatured}">â¤ï¸ ì¶”ì²œ</span>
                </div>
            </div>

            <!-- ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
            <div class="product-info-section">
                <h1 class="product-title" th:text="${product.productName}">ìƒí’ˆëª…</h1>
                
                <!-- ê°€ê²© ì •ë³´ -->
                <div class="price-section">
                    <div th:if="${product.discountRate > 0}" class="price-with-discount">
                        <span class="original-price" th:text="'â‚©' + ${#numbers.formatInteger(product.originalPrice, 3, 'COMMA')}">ì›ê°€</span>
                        <span class="discount-rate" th:text="'-' + ${product.discountRate} + '%'">í• ì¸ìœ¨</span>
                        <div class="final-price" th:text="'â‚©' + ${#numbers.formatInteger(product.price, 3, 'COMMA')}">í• ì¸ê°€</div>
                    </div>
                    <div th:unless="${product.discountRate > 0}" class="price-normal">
                        <div class="final-price" th:text="'â‚©' + ${#numbers.formatInteger(product.price, 3, 'COMMA')}">ê°€ê²©</div>
                    </div>
                </div>

                <!-- ìƒí’ˆ ê¸°ë³¸ ì •ë³´ -->
                <div class="product-meta-info">
                    <div class="meta-item">
                        <span class="meta-label">ğŸ“¦ ì¹´í…Œê³ ë¦¬</span>
                        <span class="meta-value" th:text="${product.category}">ì¹´í…Œê³ ë¦¬</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ğŸ“Š ì¬ê³ </span>
                        <span class="meta-value" th:text="${product.stock} + 'ê°œ'">ì¬ê³ </span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ğŸšš ë°°ì†¡ë¹„</span>
                        <span class="meta-value" th:text="${product.shippingFee == 0 ? 'ë¬´ë£Œë°°ì†¡' : 'â‚©' + #numbers.formatInteger(product.shippingFee, 3, 'COMMA')}">ë°°ì†¡ë¹„</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">â° ë°°ì†¡ì†Œìš”</span>
                        <span class="meta-value" th:text="${product.shippingDays} + 'ì¼'">ë°°ì†¡ì†Œìš”</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ğŸ‘€ ì¡°íšŒìˆ˜</span>
                        <span class="meta-value" th:text="${product.viewCount}">ì¡°íšŒìˆ˜</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ğŸ›’ êµ¬ë§¤ìˆ˜</span>
                        <span class="meta-value" th:text="${product.purchaseCount}">êµ¬ë§¤ìˆ˜</span>
                    </div>
                </div>

                <!-- ìƒí’ˆ ìƒíƒœ -->
                <div class="product-status">
                    <span th:if="${product.status == 'íŒë§¤ì¤‘'}" class="status-badge status-available">âœ… íŒë§¤ì¤‘</span>
                    <span th:if="${product.status == 'í’ˆì ˆ'}" class="status-badge status-soldout">âŒ í’ˆì ˆ</span>
                    <span th:if="${product.status == 'ì¤€ë¹„ì¤‘'}" class="status-badge status-preparing">â³ ì¤€ë¹„ì¤‘</span>
                </div>

                <!-- ìƒí’ˆ ì˜µì…˜ (ìˆëŠ” ê²½ìš°) -->
                <div th:if="${product.productOptions != null and !product.productOptions.isEmpty()}" class="product-options">
                    <h3>ìƒí’ˆ ì˜µì…˜</h3>
                    <div class="options-content">
                        <div class="option-group" th:each="option : ${productOptions}">
                            <label class="option-label" th:text="${option.key}">ì˜µì…˜ëª…</label>
                            <select class="option-select" th:name="'option_' + ${option.key}">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option th:each="value : ${option.value}" 
                                        th:value="${value}" 
                                        th:text="${value}">ì˜µì…˜ê°’</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ìˆ˜ëŸ‰ ì„ íƒ ë° ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° -->
                <div class="purchase-section">
                    <div class="quantity-section">
                        <label class="quantity-label">ìˆ˜ëŸ‰</label>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn" onclick="decreaseQuantity()">-</button>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" max="99" class="quantity-input">
                            <button type="button" class="quantity-btn" onclick="increaseQuantity()">+</button>
                        </div>
                    </div>
                    
                    <div class="purchase-actions">
                        <button type="button" class="btn btn-primary btn-lg" onclick="addToCart()">
                            ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg" onclick="buyNow()">
                            ğŸ’³ ë°”ë¡œ êµ¬ë§¤
                        </button>
                    </div>
                </div>

                <!-- ìƒì„¸ ì„¤ëª… -->
                <div class="product-description-section">
                    <h3>ìƒí’ˆ ì„¤ëª…</h3>
                    <div class="description-content" th:text="${product.description}">ìƒí’ˆ ì„¤ëª…</div>
                </div>

                <!-- ë“±ë¡/ìˆ˜ì • ì •ë³´ -->
                <div class="product-dates">
                    <div class="date-item">
                        <span class="date-label">ë“±ë¡ì¼</span>
                        <span class="date-value" th:text="${#temporals.format(product.regDt, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼</span>
                    </div>
                    <div class="date-item" th:if="${product.updateDt != product.regDt}">
                        <span class="date-label">ìˆ˜ì •ì¼</span>
                        <span class="date-value" th:text="${#temporals.format(product.updateDt, 'yyyy-MM-dd HH:mm')}">ìˆ˜ì •ì¼</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¦¬ë·° ì„¹ì…˜ -->
        <div class="reviews-section">
            <h2>ğŸ“ ìƒí’ˆ ë¦¬ë·°</h2>
            
            <!-- ë¦¬ë·° í†µê³„ -->
            <div class="review-stats">
                <div class="rating-summary">
                    <div class="average-rating">
                        <span class="rating-number" th:text="${averageRating}">4.5</span>
                        <div class="stars">
                            <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                  th:class="${i <= averageRating ? 'star filled' : 'star'}">â­</span>
                        </div>
                    </div>
                    <div class="rating-count" th:text="'ì´ ' + ${reviewCount} + 'ê°œ ë¦¬ë·°'">ì´ 123ê°œ ë¦¬ë·°</div>
                </div>
                
                <div class="rating-breakdown">
                    <div class="rating-bar" th:each="i : ${#numbers.sequence(5, 1)}">
                        <span class="rating-label" th:text="${i} + 'ì '">5ì </span>
                        <div class="bar-container">
                            <div class="bar-fill" th:style="'width: ' + ${ratingPercentages[i-1]} + '%'"></div>
                        </div>
                        <span class="rating-count" th:text="${ratingCounts[i-1]}">45</span>
                    </div>
                </div>
            </div>

            <!-- ë¦¬ë·° ëª©ë¡ -->
            <div class="reviews-list">
                <div class="review-item" th:each="review : ${reviews}">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <span class="reviewer-name" th:text="${review.user.userName}">êµ¬ë§¤ì</span>
                            <div class="review-rating">
                                <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                      th:class="${i <= review.rating ? 'star filled' : 'star'}">â­</span>
                            </div>
                        </div>
                        <div class="review-date" th:text="${#temporals.format(review.regDt, 'yyyy-MM-dd')}">2025-01-01</div>
                    </div>
                    
                    <div class="review-content">
                        <h4 class="review-title" th:text="${review.title}">ë¦¬ë·° ì œëª©</h4>
                        <p class="review-text" th:text="${review.content}">ë¦¬ë·° ë‚´ìš©</p>
                        <div th:if="${review.imageUrl != null}" class="review-image">
                            <img th:src="@{'/images/' + ${review.imageUrl}}" alt="ë¦¬ë·° ì´ë¯¸ì§€">
                        </div>
                    </div>
                    
                    <div class="review-footer">
                        <button class="helpful-btn" onclick="toggleHelpful(${review.id})">
                            ğŸ‘ ë„ì›€ë¨ <span th:text="${review.helpfulCount}">0</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë¦¬ë·° ì‘ì„± ë²„íŠ¼ (êµ¬ë§¤ìë§Œ) -->
            <div class="review-actions" th:if="${canWriteReview}">
                <button class="btn btn-primary" onclick="openReviewModal()">
                    âœï¸ ë¦¬ë·° ì‘ì„±í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <div th:replace="fragments/layout.html :: common-footer"></div>
    <script src="/js/comma-util.js"></script>

    <style>
        .product-detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin: 2rem 0;
        }

        .product-image-section {
            text-align: center;
        }

        .product-detail-image {
            width: 100%;
            max-width: 500px;
            height: 400px;
            object-fit: cover;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }

        .product-info-section {
            padding: 1rem;
        }

        .product-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 1.5rem;
            line-height: 1.3;
        }

        .price-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .price-with-discount {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--medium-gray);
            font-size: 1.2rem;
        }

        .discount-rate {
            background: var(--danger-color);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .final-price {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        .price-normal .final-price {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        .product-meta-info {
            margin-bottom: 2rem;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E9ECEF;
        }

        .meta-label {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .meta-value {
            color: var(--medium-gray);
        }

        .product-status {
            margin-bottom: 2rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
        }

        .status-available {
            background: var(--success-color);
            color: var(--white);
        }

        .status-soldout {
            background: var(--danger-color);
            color: var(--white);
        }

        .status-preparing {
            background: var(--warning-color);
            color: var(--dark-gray);
        }

        .product-options,
        .product-description-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .product-options h3,
        .product-description-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .description-content {
            line-height: 1.6;
            color: var(--dark-gray);
        }

        .product-dates {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }

        .date-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .date-label {
            font-weight: 600;
        }

        .purchase-section {
            margin-top: 2rem;
            padding: 2rem;
            background: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .quantity-section {
            margin-bottom: 1.5rem;
        }

        .quantity-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-gray);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--primary-color);
            background: var(--white);
            color: var(--primary-color);
            border-radius: var(--border-radius-sm);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background: var(--primary-color);
            color: var(--white);
        }

        .quantity-input {
            width: 80px;
            height: 40px;
            text-align: center;
            border: 2px solid #E9ECEF;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 600;
        }

        .purchase-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            flex: 1;
        }

        .option-group {
            margin-bottom: 1rem;
        }

        .option-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-gray);
        }

        .option-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #E9ECEF;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
        }

        .option-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .reviews-section {
            margin-top: 3rem;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .reviews-section h2 {
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        .review-stats {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .rating-summary {
            text-align: center;
        }

        .average-rating {
            margin-bottom: 1rem;
        }

        .rating-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        .stars {
            margin: 0.5rem 0;
        }

        .star {
            font-size: 1.2rem;
            margin: 0 0.1rem;
            opacity: 0.3;
        }

        .star.filled {
            opacity: 1;
        }

        .rating-count {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .rating-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rating-label {
            width: 30px;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .bar-container {
            flex: 1;
            height: 8px;
            background: #E9ECEF;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .reviews-list {
            margin-bottom: 2rem;
        }

        .review-item {
            padding: 1.5rem;
            border: 1px solid #E9ECEF;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            background: var(--white);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .reviewer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .reviewer-name {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .review-rating .star {
            font-size: 1rem;
        }

        .review-date {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        .review-content {
            margin-bottom: 1rem;
        }

        .review-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }

        .review-text {
            color: var(--dark-gray);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .review-image img {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--border-radius-sm);
        }

        .review-footer {
            display: flex;
            justify-content: flex-end;
        }

        .helpful-btn {
            background: none;
            border: 1px solid #E9ECEF;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            color: var(--medium-gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .helpful-btn:hover {
            background: var(--light-gray);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .review-actions {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid #E9ECEF;
        }

        @media (max-width: 768px) {
            .product-detail-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .product-detail-image {
                height: 300px;
            }
            
            .product-title {
                font-size: 1.5rem;
            }
            
            .final-price {
                font-size: 1.5rem;
            }

            .purchase-actions {
                flex-direction: column;
            }
        }
    </style>

    <script>
        function decreaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        }

        function increaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            const maxValue = parseInt(quantityInput.getAttribute('max'));
            if (currentValue < maxValue) {
                quantityInput.value = currentValue + 1;
            }
        }

        function addToCart() {
            const productId = /*[[${product.id}]]*/ null;
            const quantity = document.getElementById('quantity').value;
            const selectedOptions = getSelectedOptions();
            
            // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë¡œì§
            fetch('/order/customer/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: quantity,
                    options: selectedOptions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function buyNow() {
            const productId = /*[[${product.id}]]*/ null;
            const quantity = document.getElementById('quantity').value;
            const selectedOptions = getSelectedOptions();
            
            // ë°”ë¡œ êµ¬ë§¤ ë¡œì§
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/order/customer/purchase/direct';
            
            const productIdInput = document.createElement('input');
            productIdInput.type = 'hidden';
            productIdInput.name = 'productId';
            productIdInput.value = productId;
            
            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.name = 'quantity';
            quantityInput.value = quantity;
            
            const optionsInput = document.createElement('input');
            optionsInput.type = 'hidden';
            optionsInput.name = 'options';
            optionsInput.value = JSON.stringify(selectedOptions);
            
            form.appendChild(productIdInput);
            form.appendChild(quantityInput);
            form.appendChild(optionsInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        function getSelectedOptions() {
            const options = {};
            const optionSelects = document.querySelectorAll('.option-select');
            
            optionSelects.forEach(select => {
                const optionName = select.name.replace('option_', '');
                if (select.value) {
                    options[optionName] = select.value;
                }
            });
            
            return options;
        }
    </script>
</body>
</html>